---
title: chapter1.1 单指标异常检测
author: chiechie
mathjax: true
date: 2021-05-21 16:37:13
tags:
- AIOps
- 异常检测
- 异常分类
categories: 
- AIOps
---
# 目录


- [chapter0 概览](../AIOps-0-summary/)
- [chapter1 故障发现](../AIOps-1-event-generate/)
	- [chapter1.1 单指标异常检测](../AIOps-1_1-kpi-detector/)
	- [chapter1.3 故障预测](../AIOps-1_2-fault-prediction/)
	- [chapter1.4 指标异常关联](../AIOps-1_4-kpi-correlation/)
	- [chapter1.5 日志聚类](../AIOps-1_5-log-analysis/)
		- [chapter1.5.1 使用logmine加强版做日志聚类](../AIOps-1_5_1-log-analysis_logmine/)
		- [chapter1.5.2 美团日志聚类](../AIOps-1_5_2-log-analysis_meituan/)
- [chapter2 故障定位](../AIOps-2-event-analysis/)
	- [chapter2.1 微服务系统的故障定位](../AIOps-2_1-topo-rca/)
		- [chapter2.1.1 CauseInfer1](../AIOps-2_1_1-topo-rca-causeinfer-notes1/)
		- [chapter2.1.2 CauseInfer2](../AIOps-2_1_2-topo-rca-causeinfer-notes2/)
		- [chapter2.1.3 AIOps挑战赛2020-获奖方案分享](../AIOps-2_1_3-topo-rca-aiops2020/)
		- [chapter2.1.4 AIOps挑战赛2021-demo方案](../AIOps-2_1_4-topo-rca-aiops2021/)
		- [chapter2.1.5 N-Softbei2020比赛](../AIOps-2_1_5-topo-rca-cnsoftbei2020/)
		- [chapter2.1.6 MicroCause](../AIOps-2_1_6-topo-rca-MicroCause)
	- [chapter2.2 多维下钻根因定位](../AIOps-2_2-multi-dimensional-rca/): 暂无
	- [chapter2.3 调用链根因分析](../AIOps-2_3-trace_rca/)
	- [chapter2.4 时间序列关联性分析](../AIOps-2_4-metric_event_correlation/)
- chapter3 故障恢复



# 异常检测背景

运维场景的指标监控就是对时序数据做异常检测。但是，很难通过构建一个异常检测策略一劳永逸搞定所有监控需求。因为异常各异，监控指标各异（正常模式各异）。

先看一下异常有哪些。

## 异常分类

有几类异常：全局异常，条件异常，联合异常


- 全局异常点：单个点跟历史所有的数据点比，差异很大，有点像黑天鹅事件。
	![](./global_anomalie.png)
- 条件异常： 条件异常(contextual or conditional anomalies)：即相对异常，跟剩下的数据点比比较异常。举个例子：
  
	1. 我们办公室出现了一个穿西装打领带的人，会很引人注目。但是放到另外一个context中，比如房屋中介行业很正常。
	2. 凌晨销量突然升高
	![](./img.png)
- 联合异常：单个点不异常，但是群体表现出某种特殊模式，就可疑了，例如，一个小区中，有人去医院很正常，但是整个小区的人同时去医院就不正常了。
![img.png](./img78.png)
  

# 异常检测方案


时序异常检测原理，由于异常的判断依据是context，所以如何表达context信息是一个重点：

## 曲线分类 + 异常检测

如何构建曲线类型特征？

1. 周期性： autocorrelation
2. 周期offset：高斯核函数拟合分布极值
3. 趋势判断：指数滑动平均
4. 分析数据极值: 假设检验。
	

## 不同的检测策略

针对不同的业务需求，构建检测策略。

一般来说，突变点检测+上升下降屏蔽+时间收敛的策略已经可以覆盖80%的检测指标了。

对于特别重要的指标-业务核心KPI，还是有必要手动配置的。


| 案例       | 指标              | 策略                               |
|------------|-----------------|----------------------------------|
| 历史数据有中断    | 在线数据或者其他数据，入库失败 | 先使用基于插值的方法填充后再检测。                    |
| 趋势漂移是正常模式  | 游戏收入在开学季趋势漂移[1]    | 学习并且剔除这个趋势漂移，检测残差。               |
| 周期性有数据     | 定时任务日志数；礼包成交数量[2]    | 检测规律行为数据缺失                       |
| 合理范围的突变异常| 登录在线等周期性曲线      | 检测突变点                      |
| 历史数据无规律  |  刚上线的游戏和测试服               | 相对历史分布的极端异常值。                    |
| 周期性毛刺点   | 由于数据质量导致的监控指标周期性毛刺，并且间隔不固定           | 先剔除极值再检测           |
| 周期性陡增/降[3]     | 业务活动特性导致        | 1.按时间收敛；2. 模式识别[4]:         |
|无历史数据| 新接业务 ||
|历史数据无异常| 新接业务 |无监督|
|不同业务曲线对告警的敏感度不一样|在线和cpu|敏感度|


- [1]游戏收入在开学季趋势漂移: 进入开学季之后会，游戏在线人数持续走低，业务觉得正常，但是一般算法会告警
- [2]礼包成交数据，礼包只在周末某个固定时间段上架。
- [3]周期性凸起：定时启动任务导致日志数指标定时凸起，业务觉得正常，但是一般算法会告警
- [4]模式识别： 1. 使用dtw衡量两个窗口的距离，兼容偏差； 2 在历史数据中使用滚动窗口的方法，找到一个最近的窗口。

# 产品运营

用户在使用模型服务过程中的疑问

- 为什么告警？ 
  - 在模型输出的时候，把特征也带上
  - 模型开发者需要在输出中加入告警描述字段
  - 可视化saas，对告警的决策逻辑进行解释，eg上下界
- 屏蔽周期性的告警/敏感度不一样
  - 生成配置，让用户调

